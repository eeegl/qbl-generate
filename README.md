# QBL Question Generation

> *Updated "version 2" of the generation script.*

This script lets you automatically generate questions for a Question Based Learning (QBL) course using AI!

### Table of Contents

1. [Quick guide](#quick-guide)
3. [Setup](#setup)
   - [OpenAI API Key](#openai-api-key)
   - [Virtual environment](#virtual-environment)
2. [How to run it](#how-to-run-it)
   - [Examples](#examples)
4. [Skillmap](#skillmap)
5. [Prompts](#prompts)
6. [Improvement](#improvement)
7. [Config](#config)


## Quick guide

A course is generated by following a few simple steps:

0. Setup your Python environment
1. Specify the course in a skillmap
2. Create a prompt for the type of question you want
3. Run the script ([`generate.py`](src/generate.py))

The script then feeds each skill in the skillmap to the OpenAI [Chat Completions API](https://platform.openai.com/docs/guides/text-generation/chat-completions-api), together with the user defined prompt.  Responses are saved in a folder structure that mirrors the skillmap.

You can specify multiple prompts, but only one at a time can be used.

Use the `-h` flag to show how to use the script:

```bash
python generate.py -h
```

See the rest of the README for more details.


## Setup

### OpenAI API key

Store your OpenAI API key in an [environment variable](https://www3.ntu.edu.sg/home/ehchua/programming/howto/Environment_Variables.html#SetEnvUnix) named `OPENAI_API_KEY_KTH`. This is retreived in the script using the `get_api_key()` in [`prompting.py`](./src/prompting.py).

### Virtual environment

To run you need to setup the Python virtual environment in the `.venv` directory. When in the root `qbl-generate/` directory, use the following command to create the environment:

```bash
python3 -m venv .venv
```
Then activate it:

```bash
source .venv/bin/activate
```

You should then see a little `(.venv)` to the left in the CLI prompt, like so:

```bash
(.venv) [orn:~/Documents/kth/da150x-kex/question-generation/src]%
```

The final step is to install the dependencies in [`requirements.txt`](requirements.txt). Do this by running:

```bash
pip install -r requirements.txt
```

After that you should be all set to run the scripts in the virtual environment!

To deactivate the virtual environment after you are done, simply use:

```bash
deactivate
```


## How to run it

> *Make sure to complete the [setup](#setup) first.*

The script runs using the configuration in [`config.yaml`](config.yaml). However, you can override the configured behavior by passing options when running. Here you need  to specify the path to your directory, and the files you want to use.

You must also specify either of these options when generating:

- `-a/--all` generates all skills for the whole course
- `-u/--units` generates for a list of units
- `-s/--skills` generates for a list of skills

If multiple of these are given they take precedence in the order:

1. `-s/--skills`
2. `-u/--units`
3. `-a/--all`

### Examples

These are examples to get you up and running quickly. Use the `-h/--help` option for more details.

```bash
# View help
python generate.py -h
```

```bash
# Generate the whole course
python generate.py -a
```

```bash
# Generate a list of units
# NOTE: must be the exact same "name" as in the skillmap
python generate.py -u "Week 1 - Concurrency Conundrums" "Week 3 - Parallel Performance"
```

```bash
# Generate a list of skills, not necessarily from the same unit
# NOTE: must be the exact same "name" as in the skillmap
python generate.py -s "Using Channels" "Go Language Basics 2"
```

```bash
# Use custom number of questions per skill and a custom prompt and timeout
python generate.py --timeout 120 --num-questions 5 --prompt ranking.md --all
```

```bash
# Use Chat GPT 3 and bypass improvement
python generate.py --improvement-enabled false --gpt-model gpt-3.5-turbo --all
```

```bash
# Don't prepend the current config to the output file
python generate.py --logging-enabled false --all
```


## Skillmap

<!-- Folders:

- `prompts/` stores user defined prompts
- `responses/` stores the generated questions
- `src/` stores the script and other source files

Files: 

- `srs/generate.py` the script
- `skillmap.yaml` contains the skillmap
- `config.yaml` contains the script configuration
- `requirements.txt` contains the script dependencies -->

The skillmap breaks up the course into a list of units, each unit containting a list of skills. It is stored in [`skillmap.yaml`](skillmap.yaml) and written in [YAML](https://spacelift.io/blog/yaml) format for simplicity and syntax highlighting.

## Prompts

Prompts are specified in separate files. These are in [Markdown](https://www.markdownguide.org/basic-syntax/) by default to increase readability, but don't need to be.

The skill is inserted by replacing the anchor `$SKILL$` in the prompt

## Improvement

The generation process uses two steps:

1. An initial generation
2. An iterative improvement step

Improvement is enabled by default. This can be bypassed for efficiency, at the risk of generating questions of a lower quality.

## Config

The [`config.yaml`](config.yaml) file contains the script configuration. Change this if you want to avoid passing the same options over and over.
